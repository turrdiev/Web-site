<script src="https://api.bitrix24.com/api/v1/"></script>
<script>
  const templates = {
    it: ["Доступ к VPN", "Выдача техники", "Настройка Outlook"],
    hr: ["Отпуск", "Больничный", "Командировка"],
    marketing: ["Бриф", "Рекламная кампания", "Макет"]
  };

  const depSelect = document.getElementById('department');
  const reqSelect = document.getElementById('requestType');

  depSelect.addEventListener('change', () => {
    const dep = depSelect.value;
    reqSelect.innerHTML = '';

    if (!dep) {
      reqSelect.innerHTML = '<option>Сначала выберите департамент</option>';
      return;
    }

    templates[dep].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      reqSelect.appendChild(opt);
    });
  });

  BX24.ready(() => {
    BX24.placement.info((info) => {
      const dealId = info.options.ID;

      reqSelect.addEventListener('change', () => {
        BX24.callMethod(
          'crm.deal.update',
          { id: dealId, fields: { UF_CRM_1759607274: reqSelect.value } },
          (res) => console.log('Сохранено:', res)
        );
      });
    });
  });
</script>
