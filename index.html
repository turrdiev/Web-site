<script>
  // Список типов заявок по департаментам
  const templates = {
    it: ["Доступ к VPN", "Выдача техники", "Настройка Outlook"],
    hr: ["Отпуск", "Больничный", "Командировка"],
    marketing: ["Бриф", "Рекламная кампания", "Макет"]
  };

  const depSelect = document.getElementById('department');
  const reqSelect = document.getElementById('requestType');

  // При выборе департамента
  depSelect.addEventListener('change', () => {
    const dep = depSelect.value;
    reqSelect.innerHTML = '';

    if (!dep) {
      reqSelect.innerHTML = '<option>Сначала выберите департамент</option>';
      return;
    }

    // Обновляем список типов заявок
    templates[dep].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      reqSelect.appendChild(opt);
    });

    // Сохраняем выбранный департамент в сделку
    const dealId = BX24.placement.info().options.ID;
    BX24.callMethod(
      'crm.deal.update',
      { id: dealId, fields: { UF_CRM_1759607241: dep } }, // сохраняем департамент
      (res) => console.log('Департамент сохранен:', res)
    );
  });

  // При выборе типа заявки
  BX24.ready(() => {
    reqSelect.addEventListener('change', () => {
      const dealId = BX24.placement.info().options.ID;
      BX24.callMethod(
        'crm.deal.update',
        { id: dealId, fields: { UF_CRM_1759607274: reqSelect.value } }, // сохраняем тип заявки
        (res) => console.log('Тип заявки сохранен:', res)
      );
    });
  });
</script>
